<!doctype html>
<html>
<head>
    <title>Device Configurator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container py-5">
    <h1 class="mb-4">Run Device Configuration</h1>
    <div class="row g-3 align-items-end">
        <div class="col-md-2">
            <label for="manufacturer" class="form-label">Manufacturer</label>
            <select id="manufacturer" class="form-select">
                <option value="">Select...</option>
                {% for m in devices.keys() %}
                <option value="{{ m }}">{{ m }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="device" class="form-label">Device</label>
            <select id="device" class="form-select"></select>
        </div>
        <div class="col-md-2">
            <label for="site_type" class="form-label">Site Type</label>
            <select id="site_type" class="form-select"></select>
        </div>
        <div class="col-md-2">
            <label for="config_type" class="form-label">Configuration Type</label>
            <select id="config_type" class="form-select"></select>
        </div>
        <div class="col-md-2">
            <label for="script" class="form-label">Script</label>
            <select id="script" class="form-select"></select>
        </div>
        <div class="col-md-2">
            <button id="run" class="btn btn-primary w-100">Run</button>
        </div>
    </div>

    <pre id="output" class="bg-dark text-white mt-4 p-3" style="height: 300px; overflow-y: auto;"></pre>
</div>

    <script>
    const devices = {{ devices|tojson }};
    const manufSelect = document.getElementById('manufacturer');
    const deviceSelect = document.getElementById('device');
    const siteTypeSelect = document.getElementById('site_type');
    const configTypeSelect = document.getElementById('config_type');
    const scriptSelect = document.getElementById('script');

    function resetSelect(sel) {
        sel.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Select...';
        sel.appendChild(opt);
    }

    resetSelect(deviceSelect);
    resetSelect(siteTypeSelect);
    resetSelect(configTypeSelect);
    resetSelect(scriptSelect);

    manufSelect.addEventListener('change', () => {
        const m = manufSelect.value;
        resetSelect(deviceSelect);
        resetSelect(siteTypeSelect);
        resetSelect(configTypeSelect);
        resetSelect(scriptSelect);
        if (devices[m]) {
            Object.keys(devices[m]).forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                deviceSelect.appendChild(opt);
            });
        }
    });

    deviceSelect.addEventListener('change', () => {
        const m = manufSelect.value;
        const d = deviceSelect.value;
        resetSelect(siteTypeSelect);
        resetSelect(configTypeSelect);
        resetSelect(scriptSelect);
        if (devices[m] && devices[m][d]) {
            Object.keys(devices[m][d]).forEach(st => {
                const opt = document.createElement('option');
                opt.value = st;
                opt.textContent = st;
                siteTypeSelect.appendChild(opt);
            });
        }
    });

    siteTypeSelect.addEventListener('change', () => {
        const m = manufSelect.value;
        const d = deviceSelect.value;
        const st = siteTypeSelect.value;
        resetSelect(configTypeSelect);
        resetSelect(scriptSelect);
        if (devices[m] && devices[m][d] && devices[m][d][st]) {
            Object.keys(devices[m][d][st]).forEach(ct => {
                const opt = document.createElement('option');
                opt.value = ct;
                opt.textContent = ct;
                configTypeSelect.appendChild(opt);
            });
        }
    });

    configTypeSelect.addEventListener('change', () => {
        const m = manufSelect.value;
        const d = deviceSelect.value;
        const st = siteTypeSelect.value;
        const ct = configTypeSelect.value;
        resetSelect(scriptSelect);
        if (devices[m] && devices[m][d] && devices[m][d][st] && devices[m][d][st][ct]) {
            devices[m][d][st][ct].forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                scriptSelect.appendChild(opt);
            });
        }
    });

    const socket = io();
    document.getElementById('run').addEventListener('click', () => {
        const m = manufSelect.value;
        const d = deviceSelect.value;
        const st = siteTypeSelect.value;
        const ct = configTypeSelect.value;
        const s = scriptSelect.value;
        document.getElementById('output').textContent = '';
        socket.emit('run_script', {
            manufacturer: m,
            device: d,
            site_type: st,
            config_type: ct,
            script: s
        });
    });

    socket.on('output', line => {
        document.getElementById('output').textContent += line;
    });

    socket.on('finished', data => {
        document.getElementById('output').textContent += '\nProcess exited with ' + data.returncode;
    });
    </script>
</body>
</html>
